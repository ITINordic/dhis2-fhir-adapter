######### Create fhir_enrollment_rule table ###############
psql "host=localhost port=5432  dbname=dhis2-fhir user=dhis-fhir"

CREATE TABLE fhir_enrollment_rule (
  id                              UUID         NOT NULL,
  program_id                      UUID         NOT NULL,
  CONSTRAINT fhir_enrollment_rule_pk PRIMARY KEY (id),
  CONSTRAINT fhir_enrollment_rule_fk1 FOREIGN KEY (id) REFERENCES fhir_rule (id) ON DELETE CASCADE,
  CONSTRAINT fhir_enrollment_rule_fk2 FOREIGN KEY (program_id) REFERENCES fhir_tracker_program(id)
);
CREATE INDEX fhir_enrollment_rule_i1
  ON fhir_enrollment_rule (program_id);
COMMENT ON TABLE fhir_enrollment_rule IS 'Contains rules for DHIS2 Enrollment Resource Types.';
COMMENT ON COLUMN fhir_enrollment_rule.id IS 'References the rule to which this Enrollment rule belongs to.';
COMMENT ON COLUMN fhir_enrollment_rule.program_id IS 'References the tracker program to which this enrollment belongs to.';


####### CarePlan.FhirResourceMapping.ImpTeiLookupScript.Script ####################
curl -XPUT -u admin:district -H 'Content-Type: application/json' http://localhost:8081/api/scripts/63693674-8a77-11e9-a3fd-37ea6b7b7cdf -d '{
 "name" : "Care Plan TEI Lookup",
 "description" : "Lookup of the Tracked Entity Instance FHIR Resource from FHIR Care Plan.",
 "code" : "CARE_PLAN_TEI_LOOKUP",
 "scriptType" : "EVALUATE",
 "returnType" : "FHIR_RESOURCE",
 "inputType" : "FHIR_CARE_PLAN",
 "variables" : [ "CONTEXT", "INPUT" ],
}'

####### CarePlan.FhirResourceMapping.ImpTeiLookupScript.ScriptSource ####################
curl -XPUT -u admin:district -H 'Content-Type: application/json' http://localhost:8081/api/scriptSources/b9df397c-8a77-11e9-b2b3-0b6052a6ae6a -d $'{
  "sourceText" : "var fhirResource = referenceUtils.getResource(input.subject, \'Patient\');\nfhirResource",
  "sourceType" : "JAVASCRIPT",
  "fhirVersions" : [ "DSTU3", "R4" ],
  "script" : "http://localhost:8081/api/scripts/63693674-8a77-11e9-a3fd-37ea6b7b7cdf"
}'


####### CarePlan.FhirResourceMapping.ImpTeiLookupScript.ExecutableScript ####################
curl -XPUT -u admin:district -H 'Content-Type: application/json' http://localhost:8081/api/executableScripts/eaa96ad0-8a79-11e9-af27-43bae92e2e20 -d '{
  "name" : "Care Plan TEI Lookup",
  "code" : "CARE_PLAN_TEI_LOOKUP",
  "description" : "Lookup of the Tracked Entity Instance FHIR Resource from FHIR Care Plan",
  "script" : "http://localhost:8081/api/scripts/63693674-8a77-11e9-a3fd-37ea6b7b7cdf"
}'

####### CarePlan.FhirResourceMapping.ImpEnrollmentOrgLookupScript.Script ####################
curl -XPUT -u admin:district -H 'Content-Type: application/json' http://localhost:8081/api/scripts/e78aaa2c-8ae6-11e9-b4f1-073c76ff0255 -d '{
 "name" : "Org Unit Code from Care Plan Resource",
 "description" : "Extracts the organization unit code reference from the input Care Plan Resource.",
 "code" : "CARE_PLAN_ORG_UNIT_LOOKUP",
 "scriptType" : "EVALUATE",
 "returnType" : "ORG_UNIT_REF",
 "inputType" : "FHIR_CARE_PLAN",
 "variables" : [ "CONTEXT", "INPUT" ],
}'

####### CarePlan.FhirResourceMapping.ImpEnrollmentOrgLookupScript.ScriptSource ####################
curl -XPUT -u admin:district -H 'Content-Type: application/json' http://localhost:8081/api/scriptSources/492228a4-8ae8-11e9-97b2-8fb3efb2ff8f -d $'{
  "sourceText" : "function getOrganizationUnitMappedCode(organizationReference)\n{\nvar mappedCode = null;\nif (organizationReference != null)\n{\nvar hierarchy = organizationUtils.findHierarchy(organizationReference);\nif (hierarchy != null)\n{for (var i = 0; (mappedCode == null) && (i <hierarchy.size()); i++)\n{\nvar code = identifierUtils.getResourceIdentifier(hierarchy.get(i), \'ORGANIZATION\');\nif (code != null)\n{mappedCode = codeUtils.getMappedCode(code, \'ORGANIZATION\');\nif ((mappedCode == null) && args[\'useIdentifierCode\'])\n{mappedCode = organizationUtils.existsWithPrefix(code);\n}\n}\n}\n}\n}\nreturn mappedCode;}\nvar ref = null;\nvar mappedCode = getOrganizationUnitMappedCode(resource.author);\nif (mappedCode != null){\nref = context.createReference(mappedCode, \'CODE\');\n}ref",
  "sourceType" : "JAVASCRIPT",
  "fhirVersions" : [ "DSTU3", "R4" ],
  "script" : "http://localhost:8081/api/scripts/e78aaa2c-8ae6-11e9-b4f1-073c76ff0255"
}'


####### CarePlan.FhirResourceMapping.ImpEnrollmentDateLookupScript.ExecutableScript ####################
curl -XPUT -u admin:district -H 'Content-Type: application/json' http://localhost:8081/api/executableScripts/5697f68a-8ae8-11e9-9c2c-673cb19bf44f -d '{
  "name" : "Org Unit Code from Care Plan Resource"",
  "code" : "CARE_PLAN_ORG_UNIT_LOOKUP",
  "description" : "Extracts the organization unit code reference from the input Care Plan Resource.",
  "script" : "http://localhost:8081/api/scripts/e78aaa2c-8ae6-11e9-b4f1-073c76ff0255"
}'

####### CarePlan.FhirResourceMapping.ImpEnrollmentDateLookupScript.Script ####################
curl -XPUT -u admin:district -H 'Content-Type: application/json' http://localhost:8081/api/scripts/f638ba4c-8b53-11e9-89e4-e70cb21cbc8c -d '{
 "name" : "Care Plan Date Lookup",
 "description" : "Lookup of the exact date of the FHIR Care Plan.",
 "code" : "CARE_PLAN_DATE_LOOKUP",
 "scriptType" : "EVALUATE",
 "returnType" : "DATE_TIME",
 "inputType" : "FHIR_CARE_PLAN",
 "variables" : [ "CONTEXT", "INPUT" ],
}'

####### CarePlan.FhirResourceMapping.ImpEnrollmentDateLookupScript.ScriptSource ####################
curl -XPUT -u admin:district -H 'Content-Type: application/json' http://localhost:8081/api/scriptSources/22469726-8b54-11e9-b95a-93563f739422 -d $'{
  "sourceText" : "input.created",
  "sourceType" : "JAVASCRIPT",
  "fhirVersions" : [ "DSTU3", "R4" ],
  "script" : "http://localhost:8081/api/scripts/f638ba4c-8b53-11e9-89e4-e70cb21cbc8c"
}'


####### CarePlan.FhirResourceMapping.ImpEnrollmentDateLookupScript.ExecutableScript ####################
curl -XPUT -u admin:district -H 'Content-Type: application/json' http://localhost:8081/api/executableScripts/0f79f2c8-8b54-11e9-81f7-ebd621029975 -d '{
  "name" : "Care Plan Date Lookup",
  "code" : "CARE_PLAN_DATE_LOOKUP",
  "description" : "Lookup of the exact date of the FHIR Care Plan",
  "script" : "http://localhost:8081/api/scripts/f638ba4c-8b53-11e9-89e4-e70cb21cbc8c"
}'



####### CarePlan.FhirResourceMapping ###########################
curl 'http://localhost:8081/api/fhirResourceMappings' -i -u 'admin:district' -X POST \
    -H 'Content-Type: application/json' \
    -d '{
  "fhirResourceType" : "CARE_PLAN",
  "trackedEntityFhirResourceType" : "PATIENT",
  "impTeiLookupScript" : "http://localhost:8081/api/executableScripts/eaa96ad0-8a79-11e9-af27-43bae92e2e20",
  "impEnrollmentOrgLookupScript" : "http://localhost:8081/api/executableScripts/5697f68a-8ae8-11e9-9c2c-673cb19bf44f",
  "impEnrollmentDateLookupScript" : "http://localhost:8081/api/executableScripts/0f79f2c8-8b54-11e9-81f7-ebd621029975"
 }'

####### MicroPlanning.TrackerProgram ###########################
curl -XPUT -u admin:district -H 'Content-Type: application/json' http://localhost:8081/api/trackerPrograms/87831258-8aec-11e9-ac22-4fd71b810e5c -d '{
  "name": "Microplanning",
  "programReference": {
    "value": "yOGsQTP8vRE",
     "type": "ID"
  },
  "enabled": true,
  "creationEnabled": false,
  "enrollmentDateIsIncident": false,
  "expEnabled": false,
  "fhirCreateEnabled": false,
  "fhirUpdateEnabled": false,
  "fhirDeleteEnabled": false,
  "trackedEntityFhirResourceType": "PATIENT",
  "trackedEntityRule": "http://localhost:8081/api/trackedEntityRules/5f9ebdc9-852e-4c83-87ca-795946aabc35"
}'


####### CarePlanToEnrollment.EnrollmentRule ###########################
curl http://localhost:8081/api/enrollmentRules/fabf20b6-88f5-11e9-b1f7-17745b0b4a01 -i -u 'admin:district' -XPUT \
    -H 'Content-Type: application/json' \
 -d '{
  "name": "Care Plan to Enrollment",
  "enabled": true,
  "evaluationOrder": 0,
  "dhisResourceType": "ENROLLMENT",
  "fhirResourceType": "CARE_PLAN",
  "impEnabled": true,
  "expEnabled": false,
  "fhirCreateEnabled": false,
  "fhirUpdateEnabled": false,
  "fhirDeleteEnabled": false,
  "program": "http://localhost:8081/api/trackerPrograms/87831258-8aec-11e9-ac22-4fd71b810e5c"
}'

####### CarePlan.System #####################################
curl -XPUT -u admin:district -H 'Content-Type: application/json' http://localhost:8081/api/systems/7a63ef64-8aee-11e9-8ca2-cf6f2693f542 -d '{
  "name": "Zimbabwe Care Plan ID",
  "code": "ZW_CARE_PLAN_ID",
  "systemUri": "urn:ceshhar:uid",
  "fhirDisplayName": "Zimbabwe Care Plan ID"
}'

####### CarePlan.ClientResource #####################################
curl -XPUT -u admin:district -H 'Content-Type: application/json' http://localhost:8081/api/fhirClientResources/b28e733c-8aee-11e9-9928-4736812fb4de -d '{
  "fhirResourceType": "CARE_PLAN",
  "fhirClient": "http://localhost:8081/api/fhirClients/73cd99c5-0ca8-42ad-a53b-1891fccce08f",
  "exportOnly": false
}'

####### CarePlan.ClientSystem #####################################
curl -XPOST -u admin:district -H 'Content-Type: application/json' http://localhost:8081/api/fhirClientSystems -d '{
  "fhirResourceType": "CARE_PLAN",
  "fhirClient": "http://localhost:8081/api/fhirClients/73cd99c5-0ca8-42ad-a53b-1891fccce08f",
  "system": "http://localhost:8081/api/systems/7a63ef64-8aee-11e9-8ca2-cf6f2693f542"
}'

####################Subscribe for care plan notifications #################################
curl -XPOST 'http://localhost:8080/hapi-fhir-jpaserver/fhir/Subscription' -i -H 'Content-Type: application/json' -d \
  '{
      "resourceType": "Subscription",
      "criteria": "CarePlan?",
      "channel": {
        "type": "rest-hook",
        "endpoint": "http://localhost:8081/remote-fhir-rest-hook/73cd99c5-0ca8-42ad-a53b-1891fccce08f/b28e733c-8aee-11e9-9928-4736812fb4de",
        "header": "Authorization: Bearer jhsj832jDShf8ehShdu7ejhDhsilwmdsgs"
      }, 
      "status": "requested"
  }'









